<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>English Battle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .fade-message {
      transition: opacity 0.5s ease;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  {% if not user %}
  <div id="auth-area" class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
    <h2 class="text-2xl font-bold mb-4 text-indigo-600">üîê –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
    <p class="mb-6 text-gray-600">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç Chuvala ID, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ.</p>

    <a href="/login" class="block bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 w-full font-semibold transition">
      üöÄ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Chuvala SSO
    </a>
  </div>
  {% else %}
  
  <!-- –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ -->
  <div id="game-container" class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
    <div class="flex justify-between items-center mb-6">
       <span class="text-sm text-gray-500">{{ user.email }}</span>
       <a href="/logout" class="text-sm text-red-500 hover:underline">Wyiti</a>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-indigo-600">üß† English Battle</h1>

    <button id="find-game" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
      üîç –ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
    </button>

    <div id="waiting" class="mt-4 text-gray-600 hidden">
      ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...
    </div>

    <div id="game-area" class="mt-6 hidden">
      <div id="word" class="text-2xl font-semibold text-gray-800 mb-4"></div>

      <div id="translations" class="grid grid-cols-2 gap-4 mb-4"></div>

      <div id="feedback" class="fade-message text-lg font-medium mb-2 hidden"></div>

      <div id="scores" class="text-lg text-gray-700 mb-2">
        üßç‚Äç‚ôÇÔ∏è –¢—ã: <span id="your-score" class="font-bold">0</span> |
        üßç‚Äç‚ôÇÔ∏è –°–æ–ø–µ—Ä–Ω–∏–∫: <span id="opponent-score" class="font-bold">0</span>
      </div>

      <div id="game-over" class="text-xl font-bold text-indigo-700 hidden">
        <div id="game-result-message" class="mb-4"></div>
        <button id="new-game-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
          üéÆ –ù–æ–≤–∞—è –∏–≥—Ä–∞
        </button>
      </div>
    </div>
  </div>
  {% endif %}

  <script>
    {% if user %}
    // --- –ò–≥—Ä–∞ –∏ —Å–æ–∫–µ—Ç—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) ---
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO
    // Flask —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ—Å—Å–∏—é –≤ –∫—É–∫–∏, SocketIO –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
    const socket = io();

    let canAnswer = true;
    let correctAnswerGlobal = null;
    const MAX_SCORE = 15;

    const findGameButton = document.getElementById('find-game');
    const waitingDiv = document.getElementById('waiting');
    const gameArea = document.getElementById('game-area');
    const yourScoreSpan = document.getElementById('your-score');
    const opponentScoreSpan = document.getElementById('opponent-score');
    const feedbackDiv = document.getElementById('feedback');
    const gameOverDiv = document.getElementById('game-over');
    const gameResultMessage = document.getElementById('game-result-message');
    const newGameBtn = document.getElementById('new-game-btn');
    const translationsDiv = document.getElementById('translations');
    const wordDiv = document.getElementById('word');

    socket.on('connect', () => {
      console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–æ–∫–µ—Ç—É —Å id:', socket.id);
    });

    socket.on('connect_error', (err) => {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', err.message);
      // alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + err.message);
    });

    socket.on('error', (data) => {
        alert(data.message);
        window.location.href = '/'; // Reload to re-auth check
    });

    findGameButton.onclick = () => {
      findGameButton.disabled = true;
      waitingDiv.classList.remove('hidden');
      gameArea.classList.add('hidden');
      gameOverDiv.classList.add('hidden');
      feedbackDiv.classList.add('hidden');
      yourScoreSpan.textContent = '0';
      opponentScoreSpan.textContent = '0';
      socket.emit('find_game');
    };

    // –ö–æ–≥–¥–∞ –∏–≥—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞
    socket.on('game_start', (data) => {
      waitingDiv.classList.add('hidden');
      findGameButton.disabled = false;
      gameArea.classList.remove('hidden');
      updateWordAndTranslations(data.word, data.translations);
      canAnswer = true;
      feedbackDiv.classList.add('hidden');
      gameOverDiv.classList.add('hidden');
      yourScoreSpan.textContent = '0';
      opponentScoreSpan.textContent = '0';
    });

    // –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥
    socket.on('new_round', (data) => {
      updateWordAndTranslations(data.word, data.translations);
      canAnswer = true;
      feedbackDiv.classList.add('hidden');
      correctAnswerGlobal = null;
    });

    // –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–≤–µ—Ç–∞
    socket.on('answer_result', (data) => {
      canAnswer = false;

      yourScoreSpan.textContent = data.your_score;
      opponentScoreSpan.textContent = data.opponent_score;
      correctAnswerGlobal = data.correct_answer;

      if (data.you_answered === false) {
        // –û–ø–ø–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –º—ã –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∏ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        feedbackDiv.textContent = `‚è±Ô∏è –†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${data.correct_answer}`;
        feedbackDiv.className = 'fade-message text-gray-700';
        feedbackDiv.classList.remove('hidden');
        feedbackDiv.style.opacity = 1;
      } else {
        showFeedback(data.correct, data.correct_answer);
        styleAnswerButtons(data.correct);
      }
    });

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
    socket.on('game_over', (data) => {
      canAnswer = false;
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);
      
      endGame(data.message);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç–∞
      yourScoreSpan.textContent = data.final_scores[socket.id] || 0;
      
      // –ù–∞—Ö–æ–¥–∏–º —Å—á–µ—Ç —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
      const opponentId = Object.keys(data.final_scores).find(id => id !== socket.id);
      opponentScoreSpan.textContent = opponentId ? data.final_scores[opponentId] : 0;
    });

    socket.on('opponent_disconnected', () => {
      alert('üö´ –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è. –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.');
      resetGame();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–æ–≤–∞—è –∏–≥—Ä–∞"
    newGameBtn.onclick = () => {
      resetGame();
      findGameButton.click();
    };
    
    function updateWordAndTranslations(word, translations) {
      wordDiv.textContent = `üî§ ${word}`;
      translationsDiv.innerHTML = '';

      translations.forEach(tr => {
        const btn = document.createElement('button');
        btn.textContent = tr;
        btn.className = 'bg-gray-200 hover:bg-gray-300 py-2 px-4 rounded-lg transition font-medium';
        btn.onclick = () => {
          if (canAnswer) {
            socket.emit('answer', { answer: tr });
          }
        };
        translationsDiv.appendChild(btn);
      });
    }

    function styleAnswerButtons(correct) {
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-60');
        if (btn.textContent === correctAnswerGlobal) {
          btn.classList.add('bg-green-300');
        } else if (!correct && btn.textContent !== correctAnswerGlobal) {
          btn.classList.add('bg-red-300');
        }
      });
    }

    function showFeedback(correct, answer) {
      feedbackDiv.textContent = correct
        ? `‚úÖ –í–µ—Ä–Ω–æ! –û—Ç–≤–µ—Ç: ${answer}`
        : `‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${answer}`;
      feedbackDiv.className = `fade-message ${correct ? 'text-green-600' : 'text-red-600'}`;
      feedbackDiv.classList.remove('hidden');
      feedbackDiv.style.opacity = 1;

      setTimeout(() => {
        feedbackDiv.style.opacity = 0;
      }, 3000);
    }

    function endGame(message) {
      gameResultMessage.textContent = message;
      gameOverDiv.classList.remove('hidden');
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);
      canAnswer = false;
    }

    function resetGame() {
      gameArea.classList.add('hidden');
      waitingDiv.classList.add('hidden');
      findGameButton.disabled = false;
      yourScoreSpan.textContent = '0';
      opponentScoreSpan.textContent = '0';
      feedbackDiv.classList.add('hidden');
      gameOverDiv.classList.add('hidden');
      canAnswer = true;
      
      // –û—á–∏—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
      translationsDiv.innerHTML = '';
      wordDiv.textContent = '';
    }
    {% endif %}
  </script>
</body>
</html>
