<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingals</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- Font: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Outfit', sans-serif;
    }

    /* Animated Gradient Background */
    .animated-bg {
      background: linear-gradient(-45deg, #ee7752, #e65100, #1e3a8a, #23d5ab);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* Glassmorphism Card */
    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .fade-message {
      transition: opacity 0.5s ease;
    }

    /* Custom Scrollbar for list */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.4);
    }
  </style>
</head>

<body class="animated-bg min-h-screen flex items-center justify-center p-4">


  <div id="loading" class="text-xl text-white font-bold drop-shadow-md">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div class="w-full max-w-lg flex flex-col items-center gap-6">
    <!-- Global Header -->
    <h1 class="text-5xl font-extrabold text-white drop-shadow-lg tracking-tight mb-2 flex items-center gap-3">
      <span>üß†</span> Ingals
    </h1>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="auth-area"
      class="glass-card p-8 rounded-2xl w-full text-center hidden transform transition-all hover:scale-[1.01] duration-300">
      <div class="mb-6">
        <span class="text-6xl">üîê</span>
      </div>
      <h2 class="text-3xl font-bold mb-3 text-gray-800 tracking-tight">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
      <p class="mb-8 text-gray-600 leading-relaxed">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç <span
          class="font-semibold text-indigo-600">Chuvala ID</span>, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ.</p>

      <a href="/login"
        class="block bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 font-bold text-lg mb-4">
        üöÄ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ SSO
      </a>

      <div>
        <a href="/login/guest"
          class="block w-full border-2 border-dashed border-gray-300 text-gray-500 font-semibold px-6 py-3 rounded-xl hover:border-gray-400 hover:text-gray-700 hover:bg-gray-50 transition duration-300">
          üëª –ò–≥—Ä–∞—Ç—å –∫–∞–∫ –ì–æ—Å—Ç—å
        </a>
      </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ -->
    <div id="game-container"
      class="glass-card p-8 rounded-2xl w-full text-center hidden transform transition-all duration-500 relative">
      <div class="flex justify-between items-center mb-6 border-b border-gray-200 border-opacity-30 pb-4">
        <div class="flex items-center space-x-2">
          <div
            class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-xs shadow-md">
            üë§
          </div>
          <span id="user-email" class="text-sm text-gray-700 font-semibold tracking-wide"></span>
        </div>
        <a href="/logout"
          class="text-xs font-bold text-red-500 hover:text-red-600 bg-red-50 hover:bg-red-100 px-3 py-1 rounded-full transition-colors">–í—ã–π—Ç–∏</a>
      </div>



      <!-- Lobby Section -->
      <div id="lobby-area">
        <div
          class="bg-indigo-50 bg-opacity-60 border border-indigo-100 rounded-xl p-5 mb-8 backdrop-filter backdrop-blur-sm shadow-inner">
          <p class="text-indigo-900 text-sm font-medium leading-relaxed">
            üëã <span class="font-bold">–õ–æ–±–±–∏.</span> –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –∏–ª–∏ –∂–¥–∏—Ç–µ –≤—ã–∑–æ–≤–∞.
          </p>
        </div>

        <!-- Round Selector -->
        <div class="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-xl border border-indigo-200">
          <label class="text-sm font-bold text-gray-700 mb-2 block flex items-center gap-2">
            üéØ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—É–Ω–¥–æ–≤ –¥–æ –ø–æ–±–µ–¥—ã:
          </label>
          <select id="rounds-selector"
            class="w-full px-4 py-3 rounded-lg border-2 border-indigo-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all font-bold text-center text-lg text-gray-700 bg-white cursor-pointer">
            <option value="5">5 —Ä–∞—É–Ω–¥–æ–≤ ‚ö°</option>
            <option value="10">10 —Ä–∞—É–Ω–¥–æ–≤ üî•</option>
            <option value="15" selected>15 —Ä–∞—É–Ω–¥–æ–≤ ‚≠ê</option>
            <option value="20">20 —Ä–∞—É–Ω–¥–æ–≤ üí™</option>
            <option value="30">30 —Ä–∞—É–Ω–¥–æ–≤ üèÜ</option>
          </select>
        </div>

        <div class="text-left mb-4 font-bold text-gray-700 text-lg flex items-center">
          <span class="mr-2">üü¢</span> –û–∂–∏–¥–∞—é—â–∏–µ –∏–≥—Ä–æ–∫–∏:
        </div>

        <div id="players-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
          <p
            class="text-gray-500 text-sm italic text-center py-6 bg-gray-50 bg-opacity-50 rounded-xl border-2 border-dashed border-gray-200">
            –ù–∏–∫–æ–≥–æ –Ω–µ—Ç... –ü–æ–∑–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∞! üèÉ‚Äç‚ôÇÔ∏è
          </p>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard-container" class="glass-card p-6 rounded-xl mt-6">
          <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
            <span>üèÜ</span> –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤
          </h2>
          <div id="leaderboard-list" class="space-y-2 max-h-80 overflow-y-auto">
            <p class="text-gray-400 text-sm text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
          </div>
        </div>
      </div>

      <!-- Challenge Modal -->
      <div id="challenge-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
        <div
          class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-white border-opacity-40 transform scale-100 transition-transform duration-300">
          <div class="text-center mb-6">
            <div class="text-5xl mb-2">‚öîÔ∏è</div>
            <h3 class="text-2xl font-extrabold text-gray-800">–í—ã–∑–æ–≤!</h3>
          </div>
          <p class="text-gray-600 mb-6 text-center leading-relaxed">–ò–≥—Ä–æ–∫ <span id="challenger-name"
              class="font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded"></span> —Ö–æ—á–µ—Ç —Å—ã–≥—Ä–∞—Ç—å —Å –≤–∞–º–∏.</p>
          <p class="text-center mb-8">
            <span class="text-indigo-600 font-bold text-lg">–î–æ <span id="challenge-rounds" class="text-2xl">15</span>
              –ø–æ–±–µ–¥</span>
          </p>
          <div class="flex space-x-4">
            <button id="decline-btn"
              class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl hover:bg-gray-200 transition font-bold text-sm tracking-wide">–û–¢–ö–õ–û–ù–ò–¢–¨</button>
            <button id="accept-btn"
              class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl hover:shadow-lg transition font-extrabold text-sm tracking-wide shadow-md uppercase">–ü–†–ò–ù–Ø–¢–¨</button>
          </div>
        </div>
      </div>

      <!-- Active Game Section -->
      <div id="game-area" class="mt-8 hidden">
        <div id="word"
          class="text-3xl md:text-5xl font-black text-gray-800 mb-6 md:mb-10 tracking-tight drop-shadow-sm transition-all duration-300 transform hover:scale-105 cursor-default select-none break-words">
        </div>

        <div id="translations" class="grid grid-cols-2 gap-4 mb-8"></div>

        <div id="feedback"
          class="fade-message text-xl font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border h-32 flex items-center justify-center">
        </div>

        <div id="scores"
          class="flex justify-between items-center bg-gray-50 bg-opacity-80 rounded-2xl p-5 mb-8 border border-gray-100 shadow-inner">
          <div class="flex flex-col items-center">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–¢—ã</span>
            <span id="your-score" class="text-3xl font-black text-indigo-600">0</span>
          </div>
          <div class="h-10 w-px bg-gray-300"></div>
          <div class="flex flex-col items-center">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–î–æ –ø–æ–±–µ–¥—ã</span>
            <span id="winning-score" class="text-2xl font-black text-gray-600">15</span>
          </div>
          <div class="h-10 w-px bg-gray-300"></div>
          <div class="flex flex-col items-center">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
            <span id="opponent-score" class="text-3xl font-black text-pink-600">0</span>
          </div>
        </div>

        <button id="surrender-btn"
          class="mt-4 w-full border border-red-200 text-red-500 font-medium py-3 rounded-xl hover:bg-red-50 hover:text-red-700 transition flex items-center justify-center space-x-2 group">
          <span class="group-hover:scale-110 transition-transform">üè≥Ô∏è</span> <span>–°–¥–∞—Ç—å—Å—è</span>
        </button>

        <div id="game-over"
          class="text-xl font-bold text-indigo-700 hidden mt-6 p-6 bg-indigo-50 rounded-2xl border border-indigo-100 animate-pulse">
          <div id="game-result-message" class="mb-6 text-2xl"></div>
          <button id="back-to-lobby-btn"
            class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-3 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 font-bold text-lg">
            üîô –í –ª–æ–±–±–∏
          </button>
        </div>
      </div>

      <!-- Surrender Modal -->
      <div id="surrender-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
        <div
          class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-white border-opacity-40 transform scale-100 transition-transform duration-300">
          <div class="text-center mb-6">
            <div class="text-5xl mb-2">üè≥Ô∏è</div>
            <h3 class="text-2xl font-extrabold text-gray-800">–°–¥–∞—Ç—å—Å—è?</h3>
          </div>
          <p class="text-gray-600 mb-8 text-center leading-relaxed">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É –∏ –∑–∞—Å—á–∏—Ç–∞—Ç—å
            –ø–æ—Ä–∞–∂–µ–Ω–∏–µ?</p>
          <div class="flex space-x-4">
            <button id="cancel-surrender-btn"
              class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl hover:bg-gray-200 transition font-bold text-sm tracking-wide">–ù–ï–¢,
              –ò–ì–†–ê–ï–ú</button>
            <button id="confirm-surrender-btn"
              class="flex-1 bg-red-600 text-white py-3 rounded-xl hover:bg-red-700 transition font-bold text-sm tracking-wide shadow-md">–î–ê,
              –°–î–ê–Æ–°–¨</button>
          </div>
        </div>
      </div>
      <!-- Profile Setup Modal -->
      <div id="profile-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
        <div
          class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-white border-opacity-40">
          <div class="text-center mb-6">
            <div class="text-5xl mb-2">üëã</div>
            <h3 class="text-2xl font-extrabold text-gray-800">–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</h3>
          </div>
          <p class="text-gray-600 mb-6 text-center">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞.</p>
          <input type="text" id="profile-name-input" placeholder="–í–∞—à–µ –∏–º—è"
            class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all mb-4 text-center font-bold text-lg text-gray-700">
          <button id="save-profile-btn"
            class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl hover:shadow-lg transition font-bold text-lg tracking-wide shadow-md">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    </div> <!-- Closing wrapper div -->
  </div>

  <script>
    // --- Application State ---
    const state = {
      user: null
    };

    // UI Elements
    const views = {
      loading: document.getElementById('loading'),
      auth: document.getElementById('auth-area'),
      game: document.getElementById('game-container')
    };

    // Check Auth on Load
    async function checkAuth() {
      // Check if token is present in URL (SSO redirect)
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (token) {
        // Redirect to backend callback to set session
        window.location.href = `/auth/callback?token=${token}`;
        return;
      }

      try {
        const res = await fetch('/api/me');
        if (res.ok) {
          const user = await res.json();
          state.user = user;
          initGameUI(user);
        } else {
          showAuthUI();
        }
      } catch (err) {
        console.error("Auth check failed", err);
        showAuthUI();
      } finally {
        views.loading.classList.add('hidden');
      }
    }

    function showAuthUI() {
      views.auth.classList.remove('hidden');
      views.game.classList.add('hidden');
    }

    function initGameUI(user) {
      views.auth.classList.add('hidden');
      views.game.classList.remove('hidden');

      const displayName = user.name || user.email;
      document.getElementById('user-email').textContent = `${displayName} (${user.elo || 1200})`;

      if (!user.name && !user.email.startsWith('Guest_')) {
        document.getElementById('profile-modal').classList.remove('hidden');
      }

      setupSocket();
      loadLeaderboard(); // Load leaderboard after login
    }

    // --- Leaderboard Logic ---
    const leaderboardList = document.getElementById('leaderboard-list');

    async function loadLeaderboard() {
      try {
        const res = await fetch('/api/leaderboard');
        if (!res.ok) return;

        const players = await res.json();

        if (players.length === 0) {
          leaderboardList.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</p>';
          return;
        }

        leaderboardList.innerHTML = '';
        players.forEach((player, index) => {
          const item = document.createElement('div');
          const isCurrentUser = state.user && (player.name === state.user.name || player.name === state.user.email);

          item.className = `flex justify-between items-center p-3 rounded-lg transition-all ${isCurrentUser
            ? 'bg-indigo-100 border-2 border-indigo-400 font-bold'
            : 'bg-white bg-opacity-70 hover:bg-opacity-90'
            }`;

          item.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="text-lg font-black ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-400' : 'text-gray-500'}">#${index + 1}</span>
              <span class="text-sm ${isCurrentUser ? 'text-indigo-800' : 'text-gray-700'}">${player.name}</span>
            </div>
            <span class="font-bold text-sm ${isCurrentUser ? 'text-indigo-600' : 'text-gray-600'}">${player.elo}</span>
          `;

          leaderboardList.appendChild(item);
        });
      } catch (err) {
        console.error('Failed to load leaderboard:', err);
      }
    }

    // Profile Logic
    document.getElementById('save-profile-btn').onclick = async () => {
      const nameInput = document.getElementById('profile-name-input');
      const name = nameInput.value.trim();

      if (name.length < 2) {
        alert("–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤");
        return;
      }

      try {
        const res = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        });

        if (res.ok) {
          document.getElementById('profile-modal').classList.add('hidden');
          // Refresh to update UI
          window.location.reload();
        } else {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
      }
    };

    // --- Start ---
    checkAuth();

    // Load leaderboard if user is logged in
    if (state.user) {
      loadLeaderboard();
    }

    // --- Game Logic ---
    let socket;
    let canAnswer = true;
    let correctAnswerGlobal = null;

    // Elements
    const lobbyArea = document.getElementById('lobby-area');
    const playersListDiv = document.getElementById('players-list');
    const gameArea = document.getElementById('game-area');

    // Modal Elements
    const challengeModal = document.getElementById('challenge-modal');
    const challengerNameSpan = document.getElementById('challenger-name');
    const acceptBtn = document.getElementById('accept-btn');
    const declineBtn = document.getElementById('decline-btn');
    const surrenderModal = document.getElementById('surrender-modal');
    const cancelSurrenderBtn = document.getElementById('cancel-surrender-btn');
    const confirmSurrenderBtn = document.getElementById('confirm-surrender-btn');

    // State for challenge
    let currentChallengerSid = null;
    let currentChallengeRounds = 15;

    // Game Elements
    const yourScoreSpan = document.getElementById('your-score');
    const opponentScoreSpan = document.getElementById('opponent-score');
    const feedbackDiv = document.getElementById('feedback');
    const gameOverDiv = document.getElementById('game-over');
    const gameResultMessage = document.getElementById('game-result-message');
    const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
    const surrenderBtn = document.getElementById('surrender-btn');
    const translationsDiv = document.getElementById('translations');
    const wordDiv = document.getElementById('word');

    function setupSocket() {
      socket = io();

      surrenderBtn.onclick = () => {
        surrenderModal.classList.remove('hidden');
      };

      cancelSurrenderBtn.onclick = () => {
        surrenderModal.classList.add('hidden');
      };

      confirmSurrenderBtn.onclick = () => {
        socket.emit('surrender');
        surrenderModal.classList.add('hidden');
      };

      socket.on('connect', () => {
        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–æ–∫–µ—Ç—É:', socket.id);
        // Automatically enter lobby on connect
        socket.emit('enter_lobby');
      });

      socket.on('lobby_update', (players) => {
        renderLobby(players);
      });

      socket.on('challenge_received', (data) => {
        console.log('Challenge received event:', data);
        if (data.target_sid === socket.id) {
          console.log('Challenge is for me!');
          currentChallengerSid = data.challenger_sid;
          currentChallengeRounds = data.rounds || 15;
          challengerNameSpan.textContent = data.challenger_email;
          document.getElementById('challenge-rounds').textContent = currentChallengeRounds;
          challengeModal.classList.remove('hidden');
        } else {
          console.log('Challenge ignored (for someone else):', data.target_sid);
        }
      });

      socket.on('game_start', (data) => {
        // Hide lobby, show game
        lobbyArea.classList.add('hidden');
        challengeModal.classList.add('hidden'); // Ensure modal is closed
        gameArea.classList.remove('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden'); // Hide leaderboard during game

        // Ensure board is visible (if hidden by previous game_over)
        wordDiv.classList.remove('hidden');
        translationsDiv.classList.remove('hidden');
        feedbackDiv.classList.remove('hidden');

        updateWordAndTranslations(data.word, data.translations);
        canAnswer = true;
        feedbackDiv.style.opacity = 0; // Hide but keep space

        gameOverDiv.classList.add('hidden');
        surrenderBtn.classList.remove('hidden');
        yourScoreSpan.textContent = '0';
        opponentScoreSpan.textContent = '0';
        document.getElementById('winning-score').textContent = data.winning_score || 15;
      });

      // ... existing game events ...

      socket.on('new_round', (data) => {
        updateWordAndTranslations(data.word, data.translations);
        canAnswer = true;
        feedbackDiv.style.opacity = 0;
        correctAnswerGlobal = null;
      });

      socket.on('answer_result', (data) => {
        yourScoreSpan.textContent = data.your_score;
        opponentScoreSpan.textContent = data.opponent_score;

        // Only show correct answer if game is effectively over (I answered or opponent won)
        // OR if needed for feedback.

        if (data.you_answered === false) {
          // Opponent answered
          if (data.correct) {
            // Opponent WON the round
            canAnswer = false;
            correctAnswerGlobal = data.correct_answer;
            feedbackDiv.innerHTML = `üèéÔ∏è –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–≤–µ—Ç–∏–ª –≤–µ—Ä–Ω–æ!<br>–û—Ç–≤–µ—Ç: <span class="text-3xl font-black block mt-1 text-indigo-700">${data.correct_answer}</span>`;
            feedbackDiv.className = 'fade-message text-gray-700 font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border h-32 flex flex-col items-center justify-center';
            feedbackDiv.style.opacity = 1;
          } else {
            // Opponent FAILED. I can still answer!
            console.log("Opponent failed, keeping input unlocked.");
            feedbackDiv.innerHTML = `‚ùå –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—à–∏–±—Å—è! –í–∞—à —Ö–æ–¥!`;
            feedbackDiv.className = 'fade-message text-red-600 font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border border-red-200 h-32 flex flex-col items-center justify-center';
            feedbackDiv.style.opacity = 1;

            // Hide message after short delay so it doesn't annoy
            setTimeout(() => {
              if (canAnswer) feedbackDiv.style.opacity = 0;
            }, 2000);
          }
        } else {
          // I answered
          canAnswer = false;
          correctAnswerGlobal = data.correct_answer;
          showFeedback(data.correct, data.correct_answer);
          styleAnswerButtons(data.correct);
        }
      });

      socket.on('game_over', (data) => {
        canAnswer = false;

        // Hide game board to clear up UI
        wordDiv.classList.add('hidden');
        translationsDiv.classList.add('hidden');
        feedbackDiv.classList.add('hidden');
        surrenderBtn.classList.add('hidden');

        // FORCE SCORE UPDATE from final_scores to ensure consistency
        if (data.final_scores) {
          for (const [sid, score] of Object.entries(data.final_scores)) {
            if (sid === socket.id) {
              yourScoreSpan.textContent = score;
            } else {
              opponentScoreSpan.textContent = score;
            }
          }
        }

        let msg = data.message;
        if (data.elo_update) {
          const diff = data.elo_update.new - data.elo_update.old;
          const sign = diff >= 0 ? '+' : '';
          msg += `<br><span class="text-sm mt-2 block ${diff >= 0 ? 'text-green-600' : 'text-red-500'}">–†–µ–π—Ç–∏–Ω–≥: ${data.elo_update.old} ‚ûù ${data.elo_update.new} (${sign}${diff})</span>`;
        }

        // If Guest won, offer to save progress
        if (state.user && state.user.email.startsWith('Guest_') && data.winner) {
          msg += `<br><a href="/login" class="inline-block mt-3 bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-xl hover:shadow-xl transition-all duration-300 font-bold text-sm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)</a>`;
        }

        gameResultMessage.innerHTML = msg; // Changed to innerHTML to support br/span
        gameOverDiv.classList.remove('hidden');
        loadLeaderboard(); // Refresh leaderboard after game ends
      });

      socket.on('opponent_disconnected', () => {
        alert('üö´ –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è. –í–æ–∑–≤—Ä–∞—Ç –≤ –ª–æ–±–±–∏.');
        resetToLobby();
      });

      socket.on('error', (data) => {
        alert(data.message);
      });

      socket.on('debug_broadcast', (data) => {
        console.log('DEBUG BROADCAST SOCKS WORKS:', data);
      });
    }

    // Modal Handlers
    acceptBtn.onclick = () => {
      if (currentChallengerSid) {
        socket.emit('accept_challenge', {
          challenger_sid: currentChallengerSid,
          rounds: currentChallengeRounds
        });
        acceptBtn.textContent = '–ó–∞–ø—É—Å–∫...';
        acceptBtn.disabled = true;
      }
    };

    declineBtn.onclick = () => {
      if (currentChallengerSid) {
        socket.emit('decline_challenge', { challenger_sid: currentChallengerSid });
        challengeModal.classList.add('hidden');
        currentChallengerSid = null;
      }
    };

    function renderLobby(players) {
      playersListDiv.innerHTML = '';

      // Filter out self
      const others = players.filter(p => p.sid !== socket.id);

      if (others.length === 0) {
        playersListDiv.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-4">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç... –ü–æ–∑–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∞!</p>';
        return;
      }

      others.forEach(player => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-white bg-opacity-80 p-4 rounded-xl shadow-sm border border-gray-100 transform hover:scale-[1.02] transition-all duration-200';

        const nameSpan = document.createElement('div');
        nameSpan.className = 'flex flex-col text-left';

        const emailText = document.createElement('span');
        emailText.className = 'font-bold text-gray-800 text-sm';
        // Show Name if available, fallback to Email
        emailText.textContent = `${player.name || player.email} [${player.elo}]`;

        const statusText = document.createElement('span');
        statusText.className = 'text-xs text-green-500 font-medium';
        statusText.textContent = '‚óè –û–Ω–ª–∞–π–Ω';

        nameSpan.appendChild(emailText);
        nameSpan.appendChild(statusText);

        const btn = document.createElement('button');
        btn.textContent = '‚öîÔ∏è –í—ã–∑–≤–∞—Ç—å';
        btn.className = 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 tracking-wide uppercase';
        btn.onclick = () => {
          const selectedRounds = parseInt(document.getElementById('rounds-selector').value);
          console.log('Sending challenge to:', player.sid, 'with rounds:', selectedRounds);
          socket.emit('challenge_player', { target_sid: player.sid, rounds: selectedRounds });
          btn.textContent = '‚è≥ ...';
          btn.className = 'bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-xs font-bold shadow-none cursor-not-allowed';
          btn.disabled = true;
        };

        div.appendChild(nameSpan);
        div.appendChild(btn);
        playersListDiv.appendChild(div);
      });
    }

    backToLobbyBtn.onclick = () => {
      resetToLobby();
    };

    function resetToLobby() {
      gameArea.classList.add('hidden');
      lobbyArea.classList.remove('hidden');
      gameOverDiv.classList.add('hidden');
      feedbackDiv.style.opacity = 0;
      document.getElementById('leaderboard-container').classList.remove('hidden'); // Show leaderboard in lobby
      socket.emit('enter_lobby');
    }

    function updateWordAndTranslations(word, translations) {
      wordDiv.textContent = word;
      translationsDiv.innerHTML = '';
      translations.forEach(tr => {
        const btn = document.createElement('button');
        btn.textContent = tr;
        btn.className = 'relative z-10 bg-white border-2 border-gray-100 hover:border-indigo-300 hover:bg-indigo-50 py-3 px-2 md:py-4 md:px-6 rounded-xl transition-all duration-200 font-bold text-gray-700 text-sm md:text-lg shadow-sm hover:shadow-md transform hover:-translate-y-0.5 active:scale-95 break-words whitespace-normal leading-tight h-full';

        btn.addEventListener('click', function (e) {
          console.log('Button clicked (Listener):', tr);
          if (canAnswer) {
            socket.emit('answer', { answer: tr });
          } else {
            console.log('Blocked: canAnswer false');
          }
        });

        translationsDiv.appendChild(btn);
      });
    }

    // ... existing styleAnswerButtons, showFeedback, endGame ...

    function styleAnswerButtons(correct) {
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-60');
        if (btn.textContent === correctAnswerGlobal) {
          btn.classList.add('bg-green-300');
        } else if (!correct && btn.textContent !== correctAnswerGlobal) {
          btn.classList.add('bg-red-300');
        }
      });
    }

    function showFeedback(correct, answer) {
      feedbackDiv.textContent = correct
        ? `‚úÖ –í–µ—Ä–Ω–æ! –û—Ç–≤–µ—Ç: ${answer}`
        : `‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${answer}`;

      const baseClasses = 'fade-message text-xl font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border h-32 flex flex-col items-center justify-center';
      feedbackDiv.className = `${baseClasses} ${correct ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;

      // Show
      feedbackDiv.style.opacity = 1;

      setTimeout(() => {
        feedbackDiv.style.opacity = 0;
      }, 3000);
    }

    function endGame(message) {
      gameResultMessage.textContent = message;
      gameOverDiv.classList.remove('hidden');
      surrenderBtn.classList.add('hidden');
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);
      canAnswer = false;
    }
  </script>
</body>

</html>