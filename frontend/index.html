<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingals</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- Font: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <style>
    body {
      font-family: 'Outfit', sans-serif;
    }

    /* Animated Gradient Background */
    .animated-bg {
      background: linear-gradient(-45deg, #ee7752, #e65100, #1e3a8a, #23d5ab);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* Glassmorphism Card */
    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .fade-message {
      transition: opacity 0.5s ease;
    }

    /* Custom Scrollbar for list */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.4);
    }
  </style>
</head>

<body class="animated-bg min-h-screen flex items-center justify-center p-2 md:p-4">


  <div id="loading" class="text-xl text-white font-bold drop-shadow-md">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div class="w-full max-w-lg flex flex-col items-center gap-6">
    <!-- Global Header -->
    <!-- Global Header -->
    <a href="/"
      class="text-3xl md:text-5xl font-extrabold text-white drop-shadow-lg tracking-tight mb-2 flex items-center gap-3 hover:scale-105 transition-transform cursor-pointer no-underline opacity-90 hover:opacity-100">
      <span>üß†</span> Ingals
    </a>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="auth-area"
      class="glass-card p-4 md:p-8 rounded-2xl w-full text-center hidden transform transition-all hover:scale-[1.01] duration-300">
      <div class="mb-6">
        <span class="text-6xl">üîê</span>
      </div>
      <h2 class="text-3xl font-bold mb-3 text-gray-800 tracking-tight">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
      <p class="mb-8 text-gray-600 leading-relaxed">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç <span
          class="font-semibold text-indigo-600">Chuvala ID</span>, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ.</p>

      <a href="/login"
        class="block bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 font-bold text-lg mb-4">
        üöÄ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ SSO
      </a>

      <div>
        <a href="/login/guest"
          class="block w-full border-2 border-dashed border-gray-300 text-gray-500 font-semibold px-6 py-3 rounded-xl hover:border-gray-400 hover:text-gray-700 hover:bg-gray-50 transition duration-300">
          üëª –ò–≥—Ä–∞—Ç—å –∫–∞–∫ –ì–æ—Å—Ç—å
        </a>
      </div>
    </div>

    <!-- Logged In Content Wrapper -->
    <div id="logged-in-content" class="w-full hidden">
      <!-- User Info Area -->
      <div id="user-info-area"
        class="glass-card p-4 md:p-6 rounded-2xl w-full transform transition-all hover:scale-[1.01] duration-300">
        <!-- User Info Header -->
        <div
          class="flex items-center justify-between mb-8 bg-white bg-opacity-60 p-4 rounded-xl shadow-sm border border-gray-100">
          <div class="flex items-center space-x-2 cursor-pointer hover:opacity-80 transition-opacity"
            onclick="openProfile('me')">
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-xs shadow-md">
              üë§
            </div>
            <span id="user-email" class="text-sm text-gray-700 font-semibold tracking-wide"></span>
          </div>
          <a href="/logout"
            class="text-xs font-bold text-red-500 hover:text-red-600 bg-red-50 hover:bg-red-100 px-3 py-1 rounded-full transition-colors">–í—ã–π—Ç–∏</a>
        </div>



        <!-- Lobby Section -->
        <div id="lobby-area">


          <!-- Round Selector -->
          <div class="mb-6 flex items-center justify-between bg-white border border-gray-100 p-3 rounded-xl shadow-sm">
            <label class="text-sm font-bold text-gray-600 flex items-center gap-2">
              üéØ –†–∞—É–Ω–¥–æ–≤ –¥–æ –ø–æ–±–µ–¥—ã:
            </label>
            <select id="rounds-selector"
              class="px-3 py-1.5 rounded-lg border-2 border-indigo-100 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 outline-none font-bold text-gray-700 bg-indigo-50 cursor-pointer text-sm">
              <option value="5">5 ‚ö°</option>
              <option value="10">10 üî•</option>
              <option value="15" selected>15 ‚≠ê</option>
              <option value="20">20 üí™</option>
              <option value="30">30 üèÜ</option>
            </select>
          </div>

          <div class="mb-4 flex items-center justify-between">
            <div class="font-bold text-gray-700 text-lg flex items-center">
              <span class="mr-2">üü¢</span> –û–Ω–ª–∞–π–Ω: <span id="online-count" class="ml-1 text-indigo-600">0</span>
            </div>
            <div class="relative">
              <input type="text" id="player-search" placeholder="–ü–æ–∏—Å–∫..."
                class="pl-8 pr-3 py-1 text-sm border border-gray-200 rounded-full focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-100 transition-all w-32 focus:w-48 bg-gray-50 text-gray-700 font-medium">
              <span class="absolute left-2.5 top-1.5 text-gray-400 text-xs">üîç</span>
            </div>
          </div>

          <div id="players-list" class="space-y-3 mb-6 h-96 overflow-y-auto pr-2 custom-scrollbar">
            <p
              class="text-gray-500 text-sm italic text-center py-6 bg-gray-50 bg-opacity-50 rounded-xl border-2 border-dashed border-gray-200">
              –ù–∏–∫–æ–≥–æ –Ω–µ—Ç... –ü–æ–∑–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∞! üèÉ‚Äç‚ôÇÔ∏è
            </p>
          </div>

          <!-- Leaderboard -->
          <!-- Leaderboard -->
          <div id="leaderboard-container" class="glass-card p-4 md:p-6 rounded-xl mt-6">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
              <span>üèÜ</span> –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤
            </h2>
            <div id="leaderboard-list" class="space-y-2 max-h-80 overflow-y-auto">
              <p class="text-gray-400 text-sm text-center py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          </div>
        </div>

        <!-- Challenge Modal -->
        <div id="challenge-modal"
          class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
          <div
            class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-white border-opacity-40 transform scale-100 transition-transform duration-300">
            <div class="text-center mb-6">
              <div class="text-5xl mb-2">‚öîÔ∏è</div>
              <h3 class="text-2xl font-extrabold text-gray-800">–í—ã–∑–æ–≤!</h3>
            </div>
            <p class="text-gray-600 mb-6 text-center leading-relaxed">–ò–≥—Ä–æ–∫ <span id="challenger-name"
                class="font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded"></span> —Ö–æ—á–µ—Ç —Å—ã–≥—Ä–∞—Ç—å —Å –≤–∞–º–∏.</p>
            <p class="text-center mb-8">
              <span class="text-indigo-600 font-bold text-lg">–î–æ <span id="challenge-rounds" class="text-2xl">15</span>
                –ø–æ–±–µ–¥</span>
            </p>
            <div class="flex space-x-4">
              <button id="decline-btn"
                class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl hover:bg-gray-200 transition font-bold text-sm tracking-wide">–û–¢–ö–õ–û–ù–ò–¢–¨</button>
              <button id="accept-btn"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl hover:shadow-lg transition font-extrabold text-sm tracking-wide shadow-md uppercase">–ü–†–ò–ù–Ø–¢–¨</button>
            </div>
          </div>
        </div>

        <!-- Active Game Section -->
        <div id="game-area" class="mt-8 hidden">
          <div id="game-vs-header"
            class="flex flex-col justify-center items-center gap-2 text-lg font-bold text-gray-600 mb-6 w-full">
            <span id="my-name-display"
              class="max-w-full text-center text-indigo-600 text-xl font-black leading-tight">–í—ã</span>
            <span class="text-gray-400 text-sm font-bold uppercase tracking-widest leading-none">VS</span>
            <span id="opponent-name-display"
              class="max-w-full text-center text-pink-600 hover:text-pink-800 transition cursor-pointer text-xl font-black leading-tight"
              title="–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–ø–µ—Ä–Ω–∏–∫–∞">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
          </div>
          <div id="word"
            class="text-3xl md:text-5xl font-black text-gray-800 mb-6 md:mb-10 tracking-tight drop-shadow-sm transition-all duration-300 transform hover:scale-105 cursor-default select-none break-words text-center w-full">
          </div>

          <div id="translations" class="grid grid-cols-2 gap-4 mb-8"></div>

          <div id="feedback"
            class="fade-message text-xl font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border h-32 flex items-center justify-center">
          </div>

          <div id="scores"
            class="flex justify-between items-center bg-gray-50 bg-opacity-80 rounded-2xl p-5 mb-8 border border-gray-100 shadow-inner">
            <div class="flex flex-col items-center">
              <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–¢—ã</span>
              <span id="your-score" class="text-3xl font-black text-indigo-600 w-16 text-center inline-block">0</span>
            </div>
            <div class="h-10 w-px bg-gray-300"></div>
            <div class="flex flex-col items-center">
              <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">–î–æ –ø–æ–±–µ–¥—ã</span>
              <span id="winning-score" class="text-2xl font-black text-gray-600">15</span>
            </div>
            <div class="h-10 w-px bg-gray-300"></div>
            <div class="flex flex-col items-center">
              <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1"
                id="opponent-score-label">–°–æ–ø–µ—Ä–Ω–∏–∫</span>
              <span id="opponent-score" class="text-3xl font-black text-pink-600 w-16 text-center inline-block">0</span>
            </div>
          </div>

          <button id="surrender-btn"
            class="mt-4 w-full border border-red-200 text-red-500 font-medium py-3 rounded-xl hover:bg-red-50 hover:text-red-700 transition flex items-center justify-center space-x-2 group">
            <span class="group-hover:scale-110 transition-transform">üè≥Ô∏è</span> <span>–°–¥–∞—Ç—å—Å—è</span>
          </button>

          <div id="game-over"
            class="text-xl font-bold text-indigo-700 hidden mt-6 p-6 bg-indigo-50 rounded-2xl border border-indigo-100 animate-pulse">
            <div id="game-result-message" class="mb-6 text-2xl"></div>
            <button id="back-to-lobby-btn"
              class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-3 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 font-bold text-lg">
              üîô –í –ª–æ–±–±–∏
            </button>
          </div>
        </div>

        <!-- Surrender Modal -->
        <div id="surrender-modal"
          class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
          <div
            class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-white border-opacity-40 transform scale-100 transition-transform duration-300">
            <div class="text-center mb-6">
              <div class="text-5xl mb-2">üè≥Ô∏è</div>
              <h3 class="text-2xl font-extrabold text-gray-800">–°–¥–∞—Ç—å—Å—è?</h3>
            </div>
            <p class="text-gray-600 mb-8 text-center leading-relaxed">–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É –∏ –∑–∞—Å—á–∏—Ç–∞—Ç—å
              –ø–æ—Ä–∞–∂–µ–Ω–∏–µ?</p>
            <div class="flex space-x-4">
              <button id="cancel-surrender-btn"
                class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl hover:bg-gray-200 transition font-bold text-sm tracking-wide">–ù–ï–¢,
                –ò–ì–†–ê–ï–ú</button>
              <button id="confirm-surrender-btn"
                class="flex-1 bg-red-600 text-white py-3 rounded-xl hover:bg-red-700 transition font-bold text-sm tracking-wide shadow-md">–î–ê,
                –°–î–ê–Æ–°–¨</button>
            </div>
          </div>
        </div>

        <!-- Profile View Modal -->
        <div id="profile-view-modal"
          class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
          <div
            class="bg-white bg-opacity-95 p-0 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 border border-white border-opacity-40 flex flex-col max-h-[90vh] overflow-hidden">

            <!-- Header -->
            <div class="p-6 bg-gradient-to-r from-indigo-500 to-purple-600 text-white relative">
              <button onclick="document.getElementById('profile-view-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-white text-opacity-70 hover:text-opacity-100 text-2xl font-bold">&times;</button>
              <div class="flex items-center gap-4">
                <div
                  class="w-16 h-16 rounded-full bg-white text-indigo-600 flex items-center justify-center text-3xl font-bold border-4 border-white border-opacity-30">
                  üë§
                </div>
                <div>
                  <h2 id="profile-view-name" class="text-2xl font-black tracking-tight">Name</h2>
                  <div class="flex items-center gap-3 text-sm text-indigo-100 font-medium">
                    <span id="profile-view-elo">ELO: 0</span>
                    <span id="profile-view-status"
                      class="bg-green-400 bg-opacity-20 px-2 py-0.5 rounded text-xs border border-green-300 border-opacity-30 hidden">Friend</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <div
              class="flex border-b border-gray-100 px-4 md:px-6 pt-2 gap-4 md:gap-6 text-sm font-bold text-gray-500 overflow-x-auto custom-scrollbar whitespace-nowrap">
              <button onclick="switchProfileTab('stats')" id="tab-btn-stats"
                class="pb-3 border-b-2 border-transparent hover:text-indigo-600 transition-colors flex-shrink-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
              <button onclick="switchProfileTab('history')" id="tab-btn-history"
                class="pb-3 border-b-2 border-transparent hover:text-indigo-600 transition-colors flex-shrink-0">–ò—Å—Ç–æ—Ä–∏—è</button>
              <button onclick="switchProfileTab('words')" id="tab-btn-words"
                class="pb-3 border-b-2 border-transparent hover:text-indigo-600 transition-colors hidden flex-shrink-0">–°–ª–æ–≤–∞</button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto bg-gray-50 flex-1 custom-scrollbar">

              <!-- Stats Tab -->
              <div id="profile-tab-stats" class="space-y-4">
                <div class="grid grid-cols-3 gap-4">
                  <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center">
                    <div class="text-xs text-gray-400 font-bold uppercase">–í—Å–µ–≥–æ</div>
                    <div id="stats-total" class="text-2xl font-black text-gray-800">0</div>
                  </div>
                  <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center">
                    <div class="text-xs text-green-500 font-bold uppercase">–ü–æ–±–µ–¥</div>
                    <div id="stats-wins" class="text-2xl font-black text-green-600">0</div>
                  </div>
                  <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm text-center">
                    <div class="text-xs text-red-500 font-bold uppercase">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div>
                    <div id="stats-losses" class="text-2xl font-black text-red-600">0</div>
                  </div>
                </div>

                <!-- Friend Actions -->
                <div id="profile-friend-actions" class="pt-4 border-t border-gray-200 mt-4 hidden">
                  <button id="profile-add-friend-btn"
                    class="w-full py-3 rounded-xl font-bold bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition">–î–æ–±–∞–≤–∏—Ç—å
                    –≤ –¥—Ä—É–∑—å—è</button>
                </div>
              </div>

              <!-- History Tab -->
              <div id="profile-tab-history" class="hidden space-y-2">
                <p class="text-center text-gray-400 text-sm py-4">–ò—Å—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.</p>
                <div id="history-list" class="space-y-2"></div>
              </div>

              <!-- Words Tab -->
              <div id="profile-tab-words" class="hidden space-y-4">
                <div class="flex gap-2 mb-4">
                  <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">–í—ã—É—á–µ–Ω–æ: <span
                      id="words-learned-count">0</span></span>
                  <span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded">–í –ø—Ä–æ—Ü–µ—Å—Å–µ: <span
                      id="words-learning-count">0</span></span>
                </div>
                <div id="words-list" class="grid grid-cols-2 gap-2"></div>
              </div>

            </div>
          </div>
        </div>

        <!-- Profile Setup Modal -->
        <div id="profile-modal"
          class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
          <div
            class="bg-white bg-opacity-90 p-8 rounded-2xl shadow-2xl max-w-sm w-full mx-4 border border-white border-opacity-40">
            <div class="text-center mb-6">
              <div class="text-5xl mb-2">üëã</div>
              <h3 class="text-2xl font-extrabold text-gray-800">–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</h3>
            </div>
            <p class="text-gray-600 mb-6 text-center">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞.</p>
            <input type="text" id="profile-name-input" placeholder="–í–∞—à–µ –∏–º—è"
              class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all mb-4 text-center font-bold text-lg text-gray-700">
            <button id="save-profile-btn"
              class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-xl hover:shadow-lg transition font-bold text-lg tracking-wide shadow-md">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- End Logged In Wrapper -->
  </div> <!-- Closing wrapper div -->
  </div>

  <script>
    // --- Application State ---
    const state = {
      user: null
    };

    // UI Elements
    const views = {
      loading: document.getElementById('loading'),
      auth: document.getElementById('auth-area'),
      game: document.getElementById('logged-in-content')
    };

    // Check Auth on Load
    async function checkAuth() {
      // Check if token is present in URL (SSO redirect)
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (token) {
        // Redirect to backend callback to set session
        window.location.href = `/auth/callback?token=${token}`;
        return;
      }

      try {
        const res = await fetch('/api/me');
        if (res.ok) {
          const user = await res.json();
          state.user = user;
          initGameUI(user);
        } else {
          showAuthUI();
        }
      } catch (err) {
        console.error("Auth check failed", err);
        showAuthUI();
      } finally {
        views.loading.classList.add('hidden');
      }
    }

    function showAuthUI() {
      views.auth.classList.remove('hidden');
      views.game.classList.add('hidden');
    }

    function initGameUI(user) {
      views.auth.classList.add('hidden');
      views.game.classList.remove('hidden');

      const displayName = user.name || user.email;
      document.getElementById('user-email').textContent = `${displayName} (${user.elo || 1200})`;

      if (!user.name && !user.email.startsWith('Guest_')) {
        document.getElementById('profile-modal').classList.remove('hidden');
      }

      setupSocket();
      loadLeaderboard(); // Load leaderboard after login
    }

    // --- Leaderboard Logic ---
    const leaderboardList = document.getElementById('leaderboard-list');

    async function loadLeaderboard() {
      try {
        const res = await fetch('/api/leaderboard');
        if (!res.ok) return;

        const players = await res.json();

        if (players.length === 0) {
          leaderboardList.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</p>';
          return;
        }

        leaderboardList.innerHTML = '';
        players.forEach((player, index) => {
          const item = document.createElement('div');
          const isCurrentUser = state.user && (player.name === state.user.name || player.name === state.user.email);

          item.className = `flex justify-between items-center p-3 rounded-lg transition-all ${isCurrentUser
            ? 'bg-indigo-100 border-2 border-indigo-400 font-bold'
            : 'bg-white bg-opacity-70 hover:bg-opacity-90'
            }`;

          item.innerHTML = `
            <div class="flex items-center gap-3">
              <span class="text-lg font-black ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-400' : 'text-gray-500'}">#${index + 1}</span>
              <span class="text-sm ${isCurrentUser ? 'text-indigo-800' : 'text-gray-700'}">${player.name}</span>
            </div>
            <span class="font-bold text-sm ${isCurrentUser ? 'text-indigo-600' : 'text-gray-600'}">${player.elo}</span>
          `;

          leaderboardList.appendChild(item);
        });
      } catch (err) {
        console.error('Failed to load leaderboard:', err);
      }
    }

    // Profile Logic
    document.getElementById('save-profile-btn').onclick = async () => {
      const nameInput = document.getElementById('profile-name-input');
      const name = nameInput.value.trim();

      if (name.length < 2) {
        alert("–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤");
        return;
      }

      try {
        const res = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        });

        if (res.ok) {
          document.getElementById('profile-modal').classList.add('hidden');
          // Refresh to update UI
          window.location.reload();
        } else {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        }
      } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
      }
    };

    // --- Start ---
    checkAuth();

    // Load leaderboard if user is logged in
    if (state.user) {
      loadLeaderboard();
    }

    // --- Game Logic ---
    let socket;
    let canAnswer = true;
    let correctAnswerGlobal = null;

    // Elements
    const lobbyArea = document.getElementById('lobby-area');
    const playersListDiv = document.getElementById('players-list');
    const gameArea = document.getElementById('game-area');

    // Modal Elements
    const challengeModal = document.getElementById('challenge-modal');
    const challengerNameSpan = document.getElementById('challenger-name');
    const acceptBtn = document.getElementById('accept-btn');
    const declineBtn = document.getElementById('decline-btn');
    const surrenderModal = document.getElementById('surrender-modal');
    const cancelSurrenderBtn = document.getElementById('cancel-surrender-btn');
    const confirmSurrenderBtn = document.getElementById('confirm-surrender-btn');

    // State for challenge
    let currentChallengerSid = null;
    let currentChallengeRounds = 15;

    // Game Elements
    const yourScoreSpan = document.getElementById('your-score');
    const opponentScoreSpan = document.getElementById('opponent-score');
    const feedbackDiv = document.getElementById('feedback');
    const gameOverDiv = document.getElementById('game-over');
    const gameResultMessage = document.getElementById('game-result-message');
    const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
    const surrenderBtn = document.getElementById('surrender-btn');
    const translationsDiv = document.getElementById('translations');
    const wordDiv = document.getElementById('word');

    function setupSocket() {
      socket = io();

      surrenderBtn.onclick = () => {
        surrenderModal.classList.remove('hidden');
      };

      cancelSurrenderBtn.onclick = () => {
        surrenderModal.classList.add('hidden');
      };

      confirmSurrenderBtn.onclick = () => {
        socket.emit('surrender');
        surrenderModal.classList.add('hidden');
      };

      socket.on('connect', () => {
        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–æ–∫–µ—Ç—É:', socket.id);
        // Automatically enter lobby on connect
        socket.emit('enter_lobby');
      });

      socket.on('lobby_update', (data) => {
        // Handle both old list format and new {players, online_count} format
        if (Array.isArray(data)) {
          renderLobby(data);
        } else {
          renderLobby(data.players);
          document.getElementById('online-count').textContent = data.online_count || data.players.length;
        }
      });

      socket.on('challenge_received', (data) => {
        console.log('Challenge received event:', data);
        if (data.target_sid === socket.id) {
          console.log('Challenge is for me!');
          currentChallengerSid = data.challenger_sid;
          currentChallengeRounds = data.rounds || 15;
          challengerNameSpan.textContent = data.challenger_email;
          document.getElementById('challenge-rounds').textContent = currentChallengeRounds;
          challengeModal.classList.remove('hidden');
        } else {
          console.log('Challenge ignored (for someone else):', data.target_sid);
        }
      });

      socket.on('game_start', (data) => {
        // Hide lobby, show game
        lobbyArea.classList.add('hidden');
        challengeModal.classList.add('hidden'); // Ensure modal is closed
        gameArea.classList.remove('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden'); // Hide leaderboard during game

        // Ensure board is visible (if hidden by previous game_over)
        wordDiv.classList.remove('hidden');
        translationsDiv.classList.remove('hidden');
        feedbackDiv.classList.remove('hidden');

        updateWordAndTranslations(data.word, data.translations);
        canAnswer = true;
        feedbackDiv.style.opacity = 0; // Hide but keep space

        gameOverDiv.classList.add('hidden');
        surrenderBtn.classList.remove('hidden');
        yourScoreSpan.textContent = '0';
        opponentScoreSpan.textContent = '0';
        document.getElementById('winning-score').textContent = data.winning_score || 15;

        // Update Header Names
        const myNameDisplay = document.getElementById('my-name-display');
        const opponentNameDisplay = document.getElementById('opponent-name-display');

        // My Name
        myNameDisplay.textContent = (state.user && (state.user.name || state.user.email)) || "–í—ã";

        // Opponent Name
        if (data.opponent_name) {
          opponentNameDisplay.textContent = data.opponent_name;
          // Enable Profile Click on Header Name
          opponentNameDisplay.onclick = () => openProfile(data.opponent_email);
          state.opponent_email = data.opponent_email; // Store for other uses
        } else {
          opponentNameDisplay.textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫';
          opponentNameDisplay.onclick = null;
        }
      });

      // ... existing game events ...

      socket.on('new_round', (data) => {
        updateWordAndTranslations(data.word, data.translations);
        canAnswer = true;
        feedbackDiv.style.opacity = 0;
        correctAnswerGlobal = null;
      });

      socket.on('answer_result', (data) => {
        yourScoreSpan.textContent = data.your_score;
        opponentScoreSpan.textContent = data.opponent_score;

        // Only show correct answer if game is effectively over (I answered or opponent won)
        // OR if needed for feedback.

        if (data.you_answered === false) {
          // Opponent answered
          if (data.correct) {
            // Opponent WON the round
            canAnswer = false;
            correctAnswerGlobal = data.correct_answer;
            feedbackDiv.innerHTML = `üèéÔ∏è –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–≤–µ—Ç–∏–ª –≤–µ—Ä–Ω–æ!<br>–û—Ç–≤–µ—Ç: <span class="text-3xl font-black block mt-1 text-indigo-700">${data.correct_answer}</span>`;
            feedbackDiv.className = 'fade-message text-gray-700 font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border h-32 flex flex-col items-center justify-center';
            feedbackDiv.style.opacity = 1;
          } else {
            // Opponent FAILED. I can still answer!
            console.log("Opponent failed, keeping input unlocked.");
            feedbackDiv.innerHTML = `‚ùå –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—à–∏–±—Å—è! –í–∞—à —Ö–æ–¥!`;
            feedbackDiv.className = 'fade-message text-red-600 font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border border-red-200 h-32 flex flex-col items-center justify-center';
            feedbackDiv.style.opacity = 1;

            // Hide message after short delay so it doesn't annoy
            setTimeout(() => {
              if (canAnswer) feedbackDiv.style.opacity = 0;
            }, 2000);
          }
        } else {
          // I answered
          canAnswer = false;
          correctAnswerGlobal = data.correct_answer;
          showFeedback(data.correct, data.correct_answer);
          styleAnswerButtons(data.correct);
        }
      });

      socket.on('game_over', (data) => {
        canAnswer = false;

        // Hide game board to clear up UI
        wordDiv.classList.add('hidden');
        translationsDiv.classList.add('hidden');
        feedbackDiv.classList.add('hidden');
        surrenderBtn.classList.add('hidden');

        // FORCE SCORE UPDATE from final_scores to ensure consistency
        if (data.final_scores) {
          for (const [sid, score] of Object.entries(data.final_scores)) {
            if (sid === socket.id) {
              yourScoreSpan.textContent = score;
            } else {
              opponentScoreSpan.textContent = score;
            }
          }
        }

        let msg = data.message;
        if (data.elo_update) {
          const diff = data.elo_update.new - data.elo_update.old;
          const sign = diff >= 0 ? '+' : '';
          msg += `<br><span class="text-sm mt-2 block ${diff >= 0 ? 'text-green-600' : 'text-red-500'}">–†–µ–π—Ç–∏–Ω–≥: ${data.elo_update.old} ‚ûù ${data.elo_update.new} (${sign}${diff})</span>`;
        }

        // If Guest won, offer to save progress
        if (state.user && state.user.email.startsWith('Guest_') && data.winner) {
          msg += `<br><a href="/login" class="inline-block mt-3 bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-xl hover:shadow-xl transition-all duration-300 font-bold text-sm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)</a>`;
        }

        // Add Profile Link
        if (state.opponent_email) {
          msg += `<br><button onclick="openProfile('${state.opponent_email}')" class="inline-block mt-4 text-indigo-500 hover:text-indigo-700 font-bold text-sm underline opacity-80 hover:opacity-100 transition">üë§ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</button>`;
        }

        gameResultMessage.innerHTML = msg; // Changed to innerHTML to support br/span
        gameOverDiv.classList.remove('hidden');
        loadLeaderboard(); // Refresh leaderboard after game ends
      });

      socket.on('opponent_disconnected', () => {
        alert('üö´ –°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è. –í–æ–∑–≤—Ä–∞—Ç –≤ –ª–æ–±–±–∏.');
        resetToLobby();
      });

      socket.on('error', (data) => {
        alert(data.message);
      });

      socket.on('debug_broadcast', (data) => {
        console.log('DEBUG BROADCAST SOCKS WORKS:', data);
      });
    }

    // Modal Handlers
    acceptBtn.onclick = () => {
      if (currentChallengerSid) {
        socket.emit('accept_challenge', {
          challenger_sid: currentChallengerSid,
          rounds: currentChallengeRounds
        });
        acceptBtn.textContent = '–ó–∞–ø—É—Å–∫...';
        acceptBtn.disabled = true;
      }
    };

    declineBtn.onclick = () => {
      if (currentChallengerSid) {
        socket.emit('decline_challenge', { challenger_sid: currentChallengerSid });
        challengeModal.classList.add('hidden');
        currentChallengerSid = null;
      }
    };

    // --- Lobby Search ---
    let lastLobbyPlayers = [];
    const playerSearchInput = document.getElementById('player-search');

    playerSearchInput.addEventListener('input', () => {
      renderLobby(null); // Re-render using saved data but new filter
    });

    function renderLobby(players) {
      if (players) lastLobbyPlayers = players;
      const listToRender = lastLobbyPlayers || [];
      const searchTerm = playerSearchInput.value.toLowerCase();

      playersListDiv.innerHTML = '';

      // Filter out self AND apply search filter
      const others = listToRender.filter(p => {
        if (p.sid === socket.id) return false;
        const searchTarget = (p.name || p.email).toLowerCase();
        return searchTarget.includes(searchTerm);
      });

      const userFriends = new Set(state.user && state.user.friends ? state.user.friends : []);


      if (others.length === 0) {
        if (searchTerm) {
          playersListDiv.innerHTML = '<p class="text-gray-400 text-sm  text-center py-4">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üîç</p>';
        } else {
          playersListDiv.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-4">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç... –ü–æ–∑–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∞!</p>';
        }
        return;
      }

      others.sort((a, b) => {
        // 1. Friends First
        const isFriendA = userFriends.has(a.email);
        const isFriendB = userFriends.has(b.email);
        if (isFriendA && !isFriendB) return -1;
        if (!isFriendA && isFriendB) return 1;

        // 2. Humans before Bots
        // Note: Backend sends is_bot flag
        if (!a.is_bot && b.is_bot) return -1;
        if (a.is_bot && !b.is_bot) return 1;

        // 3. Name (optional, stable sort)
        return 0;
      });

      others.forEach(player => {
        const isFriend = state.user && state.user.friends ? state.user.friends.includes(player.email) : false;

        const div = document.createElement('div');
        div.className = `flex justify-between items-center bg-white bg-opacity-80 p-4 rounded-xl shadow-sm border ${isFriend ? 'border-amber-300 bg-amber-50' : 'border-gray-100'} transform hover:scale-[1.02] transition-all duration-200`;

        const leftSection = document.createElement('div');
        leftSection.className = 'flex items-center gap-3 cursor-pointer hover:opacity-70 transition-opacity min-w-0 pr-2'; // Added min-w-0 and padding right
        leftSection.onclick = (e) => {
          e.stopPropagation();
          openProfile(player.email);
        };

        // Friend Action Button
        const friendBtn = document.createElement('button');
        friendBtn.className = 'text-lg focus:outline-none transition-transform active:scale-95 hover:scale-110';
        friendBtn.title = isFriend ? "–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π" : "–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è";
        friendBtn.textContent = isFriend ? '‚≠ê' : '‚òÜ';

        friendBtn.onclick = (e) => {
          e.stopPropagation(); // Prevent other clicks
          if (isFriend) {
            removeFriend(player.email);
          } else {
            addFriend(player.email);
          }
        };


        const nameSpan = document.createElement('div');
        nameSpan.className = 'flex flex-col text-left min-w-0'; // Added min-w-0 to allow truncate

        const emailText = document.createElement('span');
        emailText.className = 'font-bold text-gray-800 text-sm flex items-center gap-2 truncate block'; // Added truncate block

        // Show Name if available, fallback to Email
        let baseName = player.name || player.email;
        let eloPart = ` [${player.elo}]`;

        // Truncate logic: Max 23 chars for NAME only
        const MAX_NAME_LEN = 23;

        // If name is longer than 23, truncate it
        if (baseName.length > MAX_NAME_LEN) {
          baseName = baseName.substring(0, MAX_NAME_LEN) + '...';
        }

        const displayName = `${baseName}${eloPart}`;

        emailText.innerHTML = isFriend
          ? `<span class="text-amber-600">${displayName}</span>`
          : displayName;

        const statusText = document.createElement('span');
        statusText.className = 'text-xs text-green-500 font-medium';
        statusText.textContent = '‚óè –û–Ω–ª–∞–π–Ω';

        nameSpan.appendChild(emailText);
        nameSpan.appendChild(statusText);

        leftSection.appendChild(friendBtn);
        leftSection.appendChild(nameSpan);

        const btn = document.createElement('button');
        btn.textContent = '‚öîÔ∏è –í—ã–∑–≤–∞—Ç—å';
        btn.className = 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-1 text-xs md:px-4 md:py-2 rounded-lg font-bold shadow hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 tracking-wide uppercase whitespace-nowrap'; // Smaller padding on mobile
        btn.onclick = () => {
          const selectedRounds = parseInt(document.getElementById('rounds-selector').value);
          console.log('Sending challenge to:', player.sid, 'with rounds:', selectedRounds);
          socket.emit('challenge_player', { target_sid: player.sid, rounds: selectedRounds });
          btn.textContent = '‚è≥ ...';
          btn.className = 'bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-xs font-bold shadow-none cursor-not-allowed';
          btn.disabled = true;
        };

        div.appendChild(leftSection);
        div.appendChild(btn);
        playersListDiv.appendChild(div);
      });
    }

    // --- Friend Actions ---
    async function addFriend(email) {
      if (!state.user) return;
      try {
        const res = await fetch('/api/friends/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ friend_email: email })
        });
        if (res.ok) {
          // Update local state
          if (!state.user.friends) state.user.friends = [];
          if (!state.user.friends.includes(email)) {
            state.user.friends.push(email);
            renderLobby(null); // Re-render
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function removeFriend(email) {
      if (!state.user) return;
      try {
        const res = await fetch('/api/friends/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ friend_email: email })
        });
        if (res.ok) {
          // Update local state
          if (state.user.friends) {
            state.user.friends = state.user.friends.filter(f => f !== email);
            renderLobby(null); // Re-render
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    backToLobbyBtn.onclick = () => {
      resetToLobby();
    };

    function resetToLobby() {
      gameArea.classList.add('hidden');
      lobbyArea.classList.remove('hidden');
      gameOverDiv.classList.add('hidden');
      feedbackDiv.style.opacity = 0;
      document.getElementById('leaderboard-container').classList.remove('hidden'); // Show leaderboard in lobby
      socket.emit('enter_lobby');
    }

    function updateWordAndTranslations(word, translations) {
      wordDiv.textContent = word;
      translationsDiv.innerHTML = '';
      translations.forEach(tr => {
        const btn = document.createElement('button');
        btn.textContent = tr;
        btn.className = 'relative z-10 bg-white border-2 border-gray-100 hover:border-indigo-300 hover:bg-indigo-50 py-3 px-2 md:py-4 md:px-6 rounded-xl transition-all duration-200 font-bold text-gray-700 text-sm md:text-lg shadow-sm hover:shadow-md transform hover:-translate-y-0.5 active:scale-95 break-words whitespace-normal leading-tight h-full';

        btn.addEventListener('click', function (e) {
          console.log('Button clicked (Listener):', tr);
          if (canAnswer) {
            socket.emit('answer', { answer: tr });
          } else {
            console.log('Blocked: canAnswer false');
          }
        });

        translationsDiv.appendChild(btn);
      });
    }

    // ... existing styleAnswerButtons, showFeedback, endGame ...

    function styleAnswerButtons(correct) {
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-60');
        if (btn.textContent === correctAnswerGlobal) {
          btn.classList.add('bg-green-300');
        } else if (!correct && btn.textContent !== correctAnswerGlobal) {
          btn.classList.add('bg-red-300');
        }
      });
    }

    function showFeedback(correct, answer) {
      feedbackDiv.textContent = correct
        ? `‚úÖ –í–µ—Ä–Ω–æ! –û—Ç–≤–µ—Ç: ${answer}`
        : `‚ùå –ù–µ–≤–µ—Ä–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${answer}`;

      const baseClasses = 'fade-message text-xl font-bold mb-6 opacity-0 p-4 rounded-xl bg-opacity-90 shadow-sm border h-32 flex flex-col items-center justify-center';
      feedbackDiv.className = `${baseClasses} ${correct ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;

      // Show
      feedbackDiv.style.opacity = 1;

      setTimeout(() => {
        feedbackDiv.style.opacity = 0;
      }, 3000);
    }

    function endGame(message) {
      gameResultMessage.textContent = message;
      gameOverDiv.classList.remove('hidden');
      surrenderBtn.classList.add('hidden');
      const buttons = translationsDiv.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = true);
      canAnswer = false;
    }

    // --- Profile Logic ---
    let currentProfileEmail = null;

    window.openProfile = async (identifier) => {
      try {
        const res = await fetch(`/api/profile/${identifier}`);
        if (!res.ok) return;
        const data = await res.json();

        currentProfileEmail = data.email;

        // Render Header
        document.getElementById('profile-view-name').textContent = data.name;
        document.getElementById('profile-view-elo').textContent = `ELO: ${data.elo}`;
        document.getElementById('profile-view-status').classList.toggle('hidden', !data.is_friend);

        // Render Stats Main
        document.getElementById('stats-total').textContent = data.stats.total_games;
        document.getElementById('stats-wins').textContent = data.stats.wins;
        document.getElementById('stats-losses').textContent = data.stats.losses;

        // Tabs visibility
        document.getElementById('tab-btn-words').classList.toggle('hidden', !data.is_me);

        // Actions
        const actionsDiv = document.getElementById('profile-friend-actions');
        const addFriendBtn = document.getElementById('profile-add-friend-btn');

        if (!data.is_me) {
          actionsDiv.classList.remove('hidden');
          if (data.is_friend) {
            addFriendBtn.textContent = "üö´ –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π";
            addFriendBtn.className = "w-full py-3 rounded-xl font-bold bg-red-50 text-red-600 hover:bg-red-100 transition";
            addFriendBtn.onclick = () => removeFriend(data.email).then(() => openProfile(data.email)); // Reload after action
          } else {
            addFriendBtn.textContent = "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è";
            addFriendBtn.className = "w-full py-3 rounded-xl font-bold bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition";
            addFriendBtn.onclick = () => addFriend(data.email).then(() => openProfile(data.email));
          }
        } else {
          actionsDiv.classList.add('hidden');
        }

        // Fetch private details if ME
        if (data.is_me) {
          const statsRes = await fetch('/api/me/stats');
          if (statsRes.ok) {
            const stats = await statsRes.json();
            renderHistory(stats.history);
            renderWords(stats.words);
            // Also enable history tab default text removal
            document.querySelector('#profile-tab-history p').classList.add('hidden');
          }
        } else {
          document.getElementById('history-list').innerHTML = '';
          document.querySelector('#profile-tab-history p').classList.remove('hidden');
          document.querySelector('#profile-tab-history p').textContent = "–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä —Å–∫—Ä—ã—Ç–∞.";
        }

        // Reset Tab to Stats
        switchProfileTab('stats');

        document.getElementById('profile-view-modal').classList.remove('hidden');

      } catch (e) {
        console.error(e);
      }
    };

    window.switchProfileTab = (tabName) => {
      // Hide all content
      ['stats', 'history', 'words'].forEach(t => {
        document.getElementById(`profile-tab-${t}`).classList.add('hidden');
        const btn = document.getElementById(`tab-btn-${t}`);
        if (btn) btn.classList.remove('border-indigo-600', 'text-indigo-600');
      });

      // Show selected
      document.getElementById(`profile-tab-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-btn-${tabName}`).classList.add('border-indigo-600', 'text-indigo-600');
    };

    function renderHistory(games) {
      const list = document.getElementById('history-list');
      list.innerHTML = '';
      games.forEach(g => {
        const el = document.createElement('div');
        el.className = `flex justify-between items-center p-3 rounded-lg border ${g.won ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`;
        el.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-bold text-gray-700 text-sm">vs ${g.opponent_name}</span>
                    <span class="text-xs text-gray-400">${new Date(g.date).toLocaleDateString()}</span>
                </div>
                <div class="font-black text-lg ${g.won ? 'text-green-600' : 'text-red-600'}">
                    ${g.my_score} : ${g.opponent_score}
                </div>
            `;
        list.appendChild(el);
      });
    }

    async function toggleWord(word) {
      try {
        const res = await fetch('/api/me/words/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word })
        });
        if (res.ok) {
          // Refresh profile stats
          const statsRes = await fetch('/api/me/stats');
          if (statsRes.ok) {
            const stats = await statsRes.json();
            renderWords(stats.words);
          }
        }
      } catch (e) { console.error(e); }
    }

    function renderWords(words) {
      const list = document.getElementById('words-list');
      list.innerHTML = '';

      // Stats: Count by status
      // Default to 'learning' if status is missing/null
      const learnedCount = words.filter(w => w.status === 'learned').length;
      document.getElementById('words-learned-count').textContent = learnedCount;
      document.getElementById('words-learning-count').textContent = words.length - learnedCount;

      words.forEach(w => {
        const isLearned = w.status === 'learned';
        const el = document.createElement('div');
        // Add cursor-pointer and onclick
        el.className = `p-3 rounded-lg border flex justify-between items-center cursor-pointer transition hover:scale-[1.02] active:scale-95 ${isLearned ? 'bg-green-50 border-green-100' : 'bg-yellow-50 border-yellow-100'}`;
        el.title = isLearned ? "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤ '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'" : "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ '–í—ã—É—á–µ–Ω–æ'";
        el.onclick = () => toggleWord(w.word);

        el.innerHTML = `
             <div class="flex flex-col">
                <span class="font-bold text-gray-700">${w.word}</span>
                <span class="text-[10px] text-gray-400">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${w.correct_count} | –û—à–∏–±–æ–∫: ${w.wrong_count}</span>
             </div>
             <div class="text-xs font-bold ${isLearned ? 'text-green-600' : 'text-yellow-600'}">
                 ${isLearned ? '‚úì –í—ã—É—á–µ–Ω–æ' : '‚ö° –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}
             </div>
        `;
        list.appendChild(el);
      });
    }

    // --- Initialization ---
    checkAuth();
  </script>
</body>

</html>